<?phpclass MageProfis_NutritionInfo_Block_Nutrition extends Mage_Core_Block_Template {    protected $_attributeGroups = array();    public function getProduct() {        return Mage::registry('current_product');    }    /**     * get nutrition attributes     * @param array $excludeAttr     * @return type     */    public function getNutritionInfo(array $excludeAttr = array()) {        $data = array();        $product = $this->getProduct();        $attributes = $product->getAttributes();        foreach ($attributes as $attribute) {            if(!$this->getAttributeGroup($attribute->getData('attribute_group_id')))            {                continue;            }            if ($attribute->getIsVisibleOnFront() && !in_array($attribute->getAttributeCode(), $excludeAttr)) {                $value = $attribute->getFrontend()->getValue($product);                if (is_string($value)) {                    if (strlen($value) && $product->hasData($attribute->getAttributeCode())) {                        if ($attribute->getFrontendInput() == 'price') {                            $value = Mage::app()->getStore()->convertPrice($value, true);                        } elseif (!$attribute->getIsHtmlAllowedOnFront()) {                            $value = $this->escapeHtml($value);                        }                        $group = 0;                        if ($tmp = $attribute->getData('attribute_group_id')) {                            $group = $tmp;                        }                        $data[$group]['items'][$attribute->getAttributeCode()] = array(                            'label' => $attribute->getFrontend()->getLabel(),                            'value' => $value,                            'code' => $attribute->getAttributeCode()                        );                        $data[$group]['attrid'] = $attribute->getId();                    }                }            }        }        foreach ($data AS $groupId => &$group) {            $groupModel = $this->getAttributeGroup($groupId);            $group['title'] = $groupModel->getAttributeGroupName();        }        return $data;    }        public function getAttributeGroup($id)    {        if (!isset($this->_attributeGroups[$id]))        {            $this->_attributeGroups[$id] = false;            $groupModel = Mage::getModel('eav/entity_attribute_group')->load($id);            $name = trim($groupModel->getAttributeGroupName());            if ($name == 'NÃ¤hrwertangaben')            {                $this->_attributeGroups[$id] = $groupModel;            }        }        return $this->_attributeGroups[$id];    }        protected function _toHtml() {        if (!Mage::getStoreConfigFlag('nutritioninfo/general/active')) {            return '';        }        return parent::_toHtml();    }}